# QMS-AI 轻量级配置中心使用指南

## 📋 概述

QMS-AI轻量级配置中心是专为本地开发和小规模部署设计的配置管理解决方案。它基于文件+内存的架构，提供配置的动态管理和热更新功能，特别适合管理8个AI模型的配置。

## 🎯 核心特性

### ✅ 已实现功能
- **📁 文件存储**: 配置以JSON文件形式存储，便于版本控制
- **🔄 热更新**: 配置变更自动生效，无需重启服务
- **🤖 AI模型管理**: 专门优化的8个AI模型配置管理
- **📡 实时通知**: 支持配置变更的实时通知机制
- **🔌 HTTP API**: 完整的RESTful API接口
- **📤 导入导出**: 支持配置的批量导入导出
- **💾 本地缓存**: 客户端缓存机制，提高性能
- **🏥 健康检查**: 完整的服务健康监控

## 🚀 快速开始

### 1. 启动配置中心

```bash
# 方式一：使用集成启动脚本（推荐）
start-with-config-center.bat

# 方式二：手动启动
cd backend/nodejs
node lightweight-config-service.js
```

### 2. 启动聊天服务

```bash
cd backend/nodejs
node chat-service.js
```

### 3. 测试功能

```bash
node test-config-center.js
```

## 🔧 API接口说明

### 基础接口

#### 健康检查
```http
GET /health
```

#### 获取所有配置名称
```http
GET /api/configs
```

#### 获取单个配置
```http
GET /api/configs/{configName}
GET /api/configs/{configName}?key=nested.key
```

#### 设置配置
```http
POST /api/configs/{configName}
Content-Type: application/json

{
  "key": "value",
  "nested": {
    "key": "value"
  }
}
```

### AI模型专用接口

#### 获取所有AI模型
```http
GET /api/ai/models
```

响应示例：
```json
{
  "success": true,
  "data": {
    "default_model": "gpt-4o",
    "models": {
      "gpt-4o": {
        "name": "GPT-4o",
        "model": "gpt-4o",
        "apiKey": "sk-xxx",
        "baseURL": "https://api.openai.com/v1",
        "maxTokens": 4096,
        "temperature": 0.7,
        "features": {
          "reasoning": false,
          "tools": true,
          "vision": true
        },
        "enabled": true
      }
    }
  }
}
```

#### 切换默认模型
```http
POST /api/ai/models/switch
Content-Type: application/json

{
  "model_key": "deepseek-chat"
}
```

#### 更新模型配置
```http
PUT /api/ai/models/{modelKey}
Content-Type: application/json

{
  "maxTokens": 8192,
  "temperature": 0.8,
  "enabled": true
}
```

### 配置管理接口

#### 导出所有配置
```http
GET /api/export
```

#### 导入配置
```http
POST /api/import
Content-Type: application/json

{
  "configs": {
    "ai_models": { ... },
    "services": { ... }
  },
  "overwrite": false
}
```

#### 实时配置变更通知（SSE）
```http
GET /api/events/config-changes
```

## 📁 配置文件结构

配置文件存储在 `backend/nodejs/config/data/` 目录下：

```
config/data/
├── ai_models.json      # AI模型配置
├── services.json       # 服务配置
└── system.json         # 系统配置
```

### AI模型配置示例 (ai_models.json)

```json
{
  "default_model": "gpt-4o",
  "models": {
    "gpt-4o": {
      "name": "GPT-4o",
      "model": "gpt-4o",
      "apiKey": "sk-xxx",
      "baseURL": "https://api.openai.com/v1",
      "maxTokens": 4096,
      "temperature": 0.7,
      "features": {
        "reasoning": false,
        "tools": true,
        "vision": true
      },
      "enabled": true
    },
    "deepseek-chat": {
      "name": "DeepSeek Chat (V3-0324)",
      "model": "deepseek-chat",
      "apiKey": "sk-xxx",
      "baseURL": "https://api.deepseek.com",
      "maxTokens": 4096,
      "temperature": 0.7,
      "features": {
        "reasoning": false,
        "tools": true,
        "vision": false
      },
      "enabled": true
    }
  },
  "rate_limits": {
    "requests_per_minute": 60,
    "requests_per_hour": 1000
  },
  "timeout": 30000,
  "retry_attempts": 3
}
```

## 🔄 配置热更新机制

### 工作原理
1. **文件监听**: 配置中心监听配置文件变更
2. **自动重载**: 文件变更时自动重新加载配置
3. **事件通知**: 通过EventEmitter通知配置变更
4. **客户端更新**: 聊天服务等客户端自动更新配置

### 使用方式
1. **直接编辑文件**: 修改 `config/data/*.json` 文件
2. **API调用**: 通过HTTP API更新配置
3. **配置端界面**: 通过前端界面管理配置

## 🎛️ 前端集成

### 配置端集成
在配置端添加配置中心管理界面：

```javascript
// 获取AI模型配置
async function getAIModels() {
  const response = await axios.get('/api/ai/models');
  return response.data;
}

// 切换模型
async function switchModel(modelKey) {
  const response = await axios.post('/api/ai/models/switch', {
    model_key: modelKey
  });
  return response.data;
}

// 监听配置变更
const eventSource = new EventSource('/api/events/config-changes');
eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  if (data.type === 'config_changed') {
    console.log('配置已变更:', data.config_name);
    // 更新界面
  }
};
```

## 🔍 监控和调试

### 健康检查
```bash
curl http://localhost:8082/health
```

### 查看配置状态
```bash
curl http://localhost:8082/api/configs
```

### 查看AI模型状态
```bash
curl http://localhost:8082/api/ai/models
```

### 日志监控
配置中心会输出详细的日志信息：
- ✅ 配置加载成功
- 📝 配置文件变更
- 📢 配置变更通知
- ❌ 错误信息

## 🚨 故障排除

### 常见问题

#### 1. 配置中心启动失败
```bash
# 检查端口占用
netstat -an | findstr :8082

# 检查配置目录权限
ls -la backend/nodejs/config/data/
```

#### 2. 配置变更不生效
- 检查文件格式是否为有效JSON
- 确认文件监听器是否正常工作
- 查看服务日志输出

#### 3. 聊天服务连接配置中心失败
- 确认配置中心已启动
- 检查网络连接
- 验证配置服务URL

### 调试技巧

#### 启用详细日志
```bash
export LOG_LEVEL=debug
node lightweight-config-service.js
```

#### 测试配置连接
```bash
node test-config-center.js
```

## 📈 性能优化

### 配置缓存
- 客户端自动缓存配置
- 支持缓存失效和更新
- 网络故障时使用缓存

### 文件监听优化
- 使用节流机制避免频繁更新
- 批量处理配置变更
- 异步处理配置加载

## 🔮 未来扩展

### 计划功能
- **配置版本管理**: 支持配置的版本控制和回滚
- **配置验证**: 添加配置格式验证和约束检查
- **集群支持**: 支持多实例配置同步
- **Web界面**: 提供专门的配置管理Web界面
- **配置模板**: 支持配置模板和继承机制

## 📞 技术支持

如有问题，请：
1. 查看日志输出
2. 运行测试脚本
3. 检查配置文件格式
4. 参考故障排除指南

---

**QMS-AI轻量级配置中心 - 让配置管理更简单** 🚀
