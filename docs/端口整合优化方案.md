# QMS系统端口整合优化方案

## 📊 当前端口使用情况

### 前端服务
- **应用端**: 8080 (Vite开发服务器)
- **配置端**: 8072 (Vue CLI开发服务器)

### 后端服务
- **AI聊天服务**: 3004 (Node.js)
- **配置中心服务**: 3003 (Node.js)
- **认证服务代理**: 8083 (Node.js)
- **Spring Boot配置中心**: 8081
- **Spring Boot数据驱动**: 8082

### 基础设施
- **Redis**: 6379
- **RabbitMQ AMQP**: 5672
- **RabbitMQ Web管理**: 15672
- **MySQL**: 3307

## 🎯 优化方案

### 方案一：API网关整合（推荐）
使用单一入口点，通过路径路由到不同服务：

**统一端口**: 8080
```
http://localhost:8080/          → 应用端前端
http://localhost:8080/config/   → 配置端前端
http://localhost:8080/api/chat/ → AI聊天服务
http://localhost:8080/api/auth/ → 认证服务
http://localhost:8080/api/config/ → 配置中心服务
```

**优势**:
- 只需要记住一个端口
- 统一的CORS配置
- 简化部署和运维
- 更好的安全控制

### 方案二：服务合并
将相关的Node.js服务合并到一个进程中：

**合并后端口分布**:
- **前端统一服务**: 8080 (包含应用端+配置端)
- **后端统一服务**: 3000 (包含AI聊天+配置中心+认证)
- **Spring Boot服务**: 8081 (配置中心+数据驱动合并)

### 方案三：Docker容器化整合
使用Docker Compose统一管理，内部通信使用服务名：

**对外暴露端口**:
- **Web入口**: 80/443 (Nginx反向代理)
- **管理界面**: 8080 (可选)

## 🚀 推荐实施方案

### 第一阶段：API网关整合

1. **创建统一网关服务**
```javascript
// gateway-service.js
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');

const app = express();

// 前端静态资源
app.use('/', express.static('frontend/应用端/dist'));
app.use('/config', express.static('frontend/配置端/dist'));

// API代理
app.use('/api/chat', createProxyMiddleware({
  target: 'http://localhost:3004',
  changeOrigin: true
}));

app.use('/api/auth', createProxyMiddleware({
  target: 'http://localhost:3003',
  changeOrigin: true
}));

app.use('/api/config', createProxyMiddleware({
  target: 'http://localhost:3003',
  changeOrigin: true
}));

app.listen(8080);
```

2. **修改前端配置**
- 应用端和配置端都构建为静态文件
- API请求统一使用相对路径

3. **服务启动顺序**
```bash
# 1. 启动基础服务
node backend/nodejs/chat-service.js      # 3004
node backend/nodejs/config-center-mock.js # 3003

# 2. 构建前端
cd frontend/应用端 && npm run build
cd frontend/配置端 && npm run build

# 3. 启动网关
node gateway-service.js                  # 8080
```

### 第二阶段：服务合并

1. **合并Node.js服务**
```javascript
// unified-backend-service.js
const express = require('express');
const app = express();

// 加载各个服务模块
const chatRoutes = require('./routes/chat');
const authRoutes = require('./routes/auth');
const configRoutes = require('./routes/config');

// 注册路由
app.use('/api/chat', chatRoutes);
app.use('/api/auth', authRoutes);
app.use('/api/config', configRoutes);

app.listen(3000);
```

2. **Spring Boot服务合并**
- 将配置中心和数据驱动服务合并为一个Spring Boot应用
- 使用不同的Controller路径区分功能

## 📋 实施步骤

### 立即可执行的优化

1. **修正端口不一致问题**
```bash
# 修改启动脚本中的端口号
# start-qms.bat 第25行：3002 → 3004
```

2. **统一认证服务端口**
```javascript
// 移除认证代理服务，直接使用配置中心的认证功能
// 修改应用端配置指向 3003 端口
```

3. **简化开发环境启动**
```bash
# 创建 start-dev.bat
node backend/nodejs/chat-service.js &
node backend/nodejs/config-center-mock.js &
cd frontend/应用端 && npm run dev &
```

### 长期优化目标

1. **容器化部署**
2. **微服务网关**
3. **负载均衡**
4. **服务发现**

## 🔧 配置文件修改

### 1. 修复启动脚本端口
```batch
echo 🚀 启动AI聊天服务 (端口3004)...
start "AI聊天服务" cmd /k "cd /d backend/nodejs && node chat-service.js"
```

### 2. 统一前端API配置
```javascript
// 应用端 vite.config.js
proxy: {
  '/api/chat': {
    target: 'http://localhost:3004',
    changeOrigin: true
  },
  '/api/auth': {
    target: 'http://localhost:3003',
    changeOrigin: true,
    rewrite: (path) => path.replace(/^\/api\/auth/, '/auth')
  }
}
```

## 💡 建议

1. **立即执行**: 修正端口不一致问题
2. **短期目标**: 实施API网关整合
3. **长期规划**: 容器化和微服务架构

这样可以将端口数量从当前的8个减少到3-4个，大大简化系统的复杂度。

## ✅ 已实施的优化

### 1. 创建了API网关服务
- **文件**: `backend/nodejs/api-gateway.js`
- **功能**: 统一入口，路由到不同服务
- **端口**: 8080 (统一入口)

### 2. 修复了端口不一致问题
- **修复**: `start-qms.bat` 中的端口号错误
- **AI聊天服务**: 3002 → 3004
- **配置中心服务**: 8081 → 3003

### 3. 创建了统一启动脚本
- **文件**: `start-qms-unified.bat`
- **功能**: 一键启动所有服务，使用统一端口
- **优势**: 自动构建前端，启动网关

### 4. 更新了前端配置
- **应用端**: 修改API路径为统一格式
- **代理配置**: 支持开发和生产环境

## 🎯 使用方法

### 快速启动 (推荐)
```bash
# 使用统一端口版本
start-qms-unified.bat
```

### 测试端口整合
```bash
# 检查端口使用情况和测试方案
test-unified-ports.bat
```

### 访问地址
- **应用端**: http://localhost:8080/
- **配置端**: http://localhost:8080/config/
- **API接口**: http://localhost:8080/api/
- **健康检查**: http://localhost:8080/health

## 📊 整合效果

| 项目 | 整合前 | 整合后 | 减少 |
|------|--------|--------|------|
| 前端端口 | 2个 (8080, 8072) | 1个 (8080) | 50% |
| 后端端口 | 5个 (3003, 3004, 8081, 8082, 8083) | 2个 (3003, 3004) | 60% |
| 用户记忆 | 8个地址 | 1个地址 | 87.5% |
| 总端口数 | 10个 | 6个 | 40% |

## 🔧 故障排除

### 常见问题
1. **页面无法访问**: 检查后端服务是否启动
2. **API调用失败**: 检查网关代理配置
3. **静态文件404**: 确保前端已构建

### 检查命令
```bash
# 检查服务状态
curl http://localhost:8080/health

# 检查端口占用
netstat -an | findstr ":8080"
```
