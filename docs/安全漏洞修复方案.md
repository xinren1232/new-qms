# QMS-AIç³»ç»Ÿå®‰å…¨æ¼æ´ä¿®å¤æ–¹æ¡ˆ

## ğŸš¨ é«˜ä¼˜å…ˆçº§å®‰å…¨æ¼æ´ä¿®å¤

### 1. JWTè®¤è¯æœºåˆ¶æ ‡å‡†åŒ–

#### å½“å‰é—®é¢˜
```javascript
// å­˜åœ¨å®‰å…¨æ¼æ´çš„TokenéªŒè¯
function verifyToken(token) {
  try {
    const payload = JSON.parse(Buffer.from(token, 'base64').toString());
    if (payload.exp < Date.now()) {
      return null; // ä»…æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼Œæ²¡æœ‰ç­¾åéªŒè¯
    }
    return payload;
  } catch (error) {
    return null;
  }
}
```

#### ä¿®å¤æ–¹æ¡ˆ
```javascript
// å®‰è£…ä¾èµ–
npm install jsonwebtoken bcryptjs

// æ ‡å‡†JWTå®ç°
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');

const JWT_SECRET = process.env.JWT_SECRET || 'your-super-secret-key-change-in-production';
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '24h';

// ç”ŸæˆToken
function generateToken(user) {
  return jwt.sign(
    {
      userId: user.id,
      username: user.username,
      roles: user.roles
    },
    JWT_SECRET,
    {
      expiresIn: JWT_EXPIRES_IN,
      issuer: 'qms-ai-system',
      audience: 'qms-ai-users'
    }
  );
}

// éªŒè¯Token
function verifyToken(token) {
  try {
    return jwt.verify(token, JWT_SECRET, {
      issuer: 'qms-ai-system',
      audience: 'qms-ai-users'
    });
  } catch (error) {
    console.error('TokenéªŒè¯å¤±è´¥:', error.message);
    return null;
  }
}

// å¯†ç åŠ å¯†
async function hashPassword(password) {
  const saltRounds = 12;
  return await bcrypt.hash(password, saltRounds);
}

// å¯†ç éªŒè¯
async function verifyPassword(password, hashedPassword) {
  return await bcrypt.compare(password, hashedPassword);
}
```

### 2. APIè¾“å…¥éªŒè¯ä¸­é—´ä»¶

#### ä¿®å¤æ–¹æ¡ˆ
```javascript
// å®‰è£…éªŒè¯åº“
npm install joi express-rate-limit helmet

const Joi = require('joi');
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');

// å®‰å…¨ä¸­é—´ä»¶
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  }
}));

// APIé™æµ
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // é™åˆ¶æ¯ä¸ªIP 15åˆ†é’Ÿå†…æœ€å¤š100ä¸ªè¯·æ±‚
  message: {
    success: false,
    message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
  }
});

app.use('/api/', apiLimiter);

// è¾“å…¥éªŒè¯ä¸­é—´ä»¶
function validateInput(schema) {
  return (req, res, next) => {
    const { error } = schema.validate(req.body);
    if (error) {
      return res.status(400).json({
        success: false,
        message: 'è¾“å…¥æ•°æ®éªŒè¯å¤±è´¥',
        details: error.details.map(detail => detail.message)
      });
    }
    next();
  };
}

// èŠå¤©æ¶ˆæ¯éªŒè¯schema
const chatMessageSchema = Joi.object({
  message: Joi.string().min(1).max(10000).required(),
  model: Joi.string().valid('gpt-4o', 'o3', 'gemini-2.5-pro-thinking', 'claude-3.7-sonnet', 'deepseek-r1', 'deepseek-v3').optional(),
  conversation_id: Joi.string().uuid().optional(),
  temperature: Joi.number().min(0).max(2).optional(),
  max_tokens: Joi.number().min(1).max(8192).optional()
});

// åº”ç”¨éªŒè¯
app.post('/api/chat/send', validateInput(chatMessageSchema), async (req, res) => {
  // å®‰å…¨çš„å¤„ç†é€»è¾‘
});
```

### 3. æ•æ„Ÿä¿¡æ¯ç¯å¢ƒå˜é‡åŒ–

#### ä¿®å¤æ–¹æ¡ˆ
```javascript
// åˆ›å»º .env æ–‡ä»¶
AI_API_KEY=your_actual_api_key_here
AI_BASE_URL=https://hk-intra-paas.transsion.com/tranai-proxy/v1
JWT_SECRET=your_super_secret_jwt_key_here
DB_PASSWORD=your_database_password_here
REDIS_PASSWORD=your_redis_password_here

// æ›´æ–°é…ç½®æ–‡ä»¶
require('dotenv').config();

const AI_CONFIGS = {
  'gpt-4o': {
    name: 'GPT-4o',
    model: 'gpt-4o',
    apiKey: process.env.AI_API_KEY, // ä»ç¯å¢ƒå˜é‡è¯»å–
    baseURL: process.env.AI_BASE_URL,
    maxTokens: 4096,
    temperature: 0.7
  }
  // ... å…¶ä»–é…ç½®
};

// å¯åŠ¨æ—¶æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
function checkRequiredEnvVars() {
  const required = ['AI_API_KEY', 'JWT_SECRET', 'AI_BASE_URL'];
  const missing = required.filter(key => !process.env[key]);
  
  if (missing.length > 0) {
    console.error('âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡:', missing.join(', '));
    process.exit(1);
  }
}

checkRequiredEnvVars();
```

### 4. SQLæ³¨å…¥é˜²æŠ¤

#### ä¿®å¤æ–¹æ¡ˆ
```javascript
// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
const sqlite3 = require('sqlite3').verbose();

// é”™è¯¯ç¤ºä¾‹ï¼ˆå­˜åœ¨SQLæ³¨å…¥é£é™©ï¼‰
// const query = `SELECT * FROM users WHERE username = '${username}'`;

// æ­£ç¡®ç¤ºä¾‹ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
function getUserByUsername(username) {
  return new Promise((resolve, reject) => {
    const query = 'SELECT * FROM users WHERE username = ?';
    db.get(query, [username], (err, row) => {
      if (err) {
        reject(err);
      } else {
        resolve(row);
      }
    });
  });
}

// æ‰¹é‡æ“ä½œä¹Ÿè¦ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
function insertChatHistory(records) {
  const query = `
    INSERT INTO chat_history (id, user_id, message, response, timestamp)
    VALUES (?, ?, ?, ?, ?)
  `;
  
  const stmt = db.prepare(query);
  
  records.forEach(record => {
    stmt.run([record.id, record.userId, record.message, record.response, record.timestamp]);
  });
  
  stmt.finalize();
}
```

### 5. XSSé˜²æŠ¤

#### å‰ç«¯ä¿®å¤
```javascript
// å®‰è£…XSSé˜²æŠ¤åº“
npm install dompurify

import DOMPurify from 'dompurify';

// è¾“å‡ºæ—¶è¿›è¡ŒHTMLè½¬ä¹‰
function sanitizeHtml(html) {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br'],
    ALLOWED_ATTR: ['href']
  });
}

// Vueç»„ä»¶ä¸­ä½¿ç”¨
export default {
  methods: {
    renderMessage(message) {
      return sanitizeHtml(message);
    }
  }
}
```

#### åç«¯ä¿®å¤
```javascript
// å®‰è£…è½¬ä¹‰åº“
npm install escape-html

const escapeHtml = require('escape-html');

// APIå“åº”æ—¶è½¬ä¹‰HTML
app.post('/api/chat/send', async (req, res) => {
  try {
    const { message } = req.body;
    
    // è½¬ä¹‰ç”¨æˆ·è¾“å…¥
    const safeMessage = escapeHtml(message);
    
    // å¤„ç†AIå“åº”
    const aiResponse = await callAIAPI(safeMessage);
    
    res.json({
      success: true,
      data: {
        message: safeMessage,
        response: escapeHtml(aiResponse.content)
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯'
    });
  }
});
```

### 6. CSRFé˜²æŠ¤

#### ä¿®å¤æ–¹æ¡ˆ
```javascript
// å®‰è£…CSRFé˜²æŠ¤ä¸­é—´ä»¶
npm install csurf

const csrf = require('csurf');

// é…ç½®CSRFä¿æŠ¤
const csrfProtection = csrf({
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict'
  }
});

// åº”ç”¨CSRFä¿æŠ¤åˆ°éœ€è¦çš„è·¯ç”±
app.use('/api/admin/', csrfProtection);
app.use('/api/config/', csrfProtection);

// æä¾›CSRF tokenç»™å‰ç«¯
app.get('/api/csrf-token', csrfProtection, (req, res) => {
  res.json({
    success: true,
    csrfToken: req.csrfToken()
  });
});
```

### 7. å®‰å…¨é…ç½®åŠ å¼º

#### ä¿®å¤æ–¹æ¡ˆ
```javascript
// å®‰å…¨é…ç½®
app.use(helmet({
  // å†…å®¹å®‰å…¨ç­–ç•¥
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.openai.com"]
    }
  },
  // å¼ºåˆ¶HTTPS
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));

// éšè—æœåŠ¡å™¨ä¿¡æ¯
app.disable('x-powered-by');

// è®¾ç½®å®‰å…¨å¤´
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  next();
});
```

## ğŸ“‹ ä¿®å¤å®æ–½è®¡åˆ’

### ç¬¬ä¸€å‘¨ï¼ˆP0ä¼˜å…ˆçº§ï¼‰
- [ ] JWTè®¤è¯æœºåˆ¶æ ‡å‡†åŒ–
- [ ] ç§»é™¤ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- [ ] æ·»åŠ åŸºç¡€è¾“å…¥éªŒè¯

### ç¬¬äºŒå‘¨ï¼ˆP1ä¼˜å…ˆçº§ï¼‰
- [ ] å®ç°APIé™æµ
- [ ] SQLæ³¨å…¥é˜²æŠ¤
- [ ] XSSé˜²æŠ¤æœºåˆ¶

### ç¬¬ä¸‰å‘¨ï¼ˆP2ä¼˜å…ˆçº§ï¼‰
- [ ] CSRFé˜²æŠ¤
- [ ] å®‰å…¨é…ç½®åŠ å¼º
- [ ] å®‰å…¨æµ‹è¯•éªŒè¯

### ç¬¬å››å‘¨ï¼ˆéªŒè¯å’Œæ–‡æ¡£ï¼‰
- [ ] å®‰å…¨æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°
- [ ] å›¢é˜ŸåŸ¹è®­

## ğŸ§ª å®‰å…¨æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•
```bash
# å®‰è£…å®‰å…¨æµ‹è¯•å·¥å…·
npm install --save-dev jest supertest

# åˆ›å»ºå®‰å…¨æµ‹è¯•ç”¨ä¾‹
describe('Security Tests', () => {
  test('should reject invalid JWT tokens', async () => {
    const response = await request(app)
      .get('/api/protected')
      .set('Authorization', 'Bearer invalid-token');
    
    expect(response.status).toBe(401);
  });
  
  test('should prevent SQL injection', async () => {
    const maliciousInput = "'; DROP TABLE users; --";
    const response = await request(app)
      .post('/api/login')
      .send({ username: maliciousInput, password: 'test' });
    
    expect(response.status).toBe(400);
  });
});
```

è¿™ä¸ªä¿®å¤æ–¹æ¡ˆè§£å†³äº†æ£€æŸ¥ä¸­å‘ç°çš„ä¸»è¦å®‰å…¨æ¼æ´ï¼Œå»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½ã€‚
