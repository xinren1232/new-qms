# 🌐 QMS-AI系统端口设计规范 (v3.0)

## 📋 端口分配总览 - 当前实际运行状态

### 🎯 设计原则
- **端口范围分离**: 前端(8080-8099) | 后端(3000-3999) | 基础设施(6000-6999)
- **服务隔离**: 每个服务独占端口，避免冲突
- **易于记忆**: 端口号与服务功能相关联
- **扩展性**: 预留端口用于未来服务扩展

---

## 🔧 后端服务端口 (3000-3999)

| 端口 | 服务名称 | 文件名 | 功能描述 | 状态 |
|------|----------|--------|----------|------|
| **3004** | AI聊天服务 | `chat-service.js` | 8个AI模型聊天功能 | ✅ 运行中 |
| 3005 | 高级功能服务 | `advanced-features-service.js` | 数据导出、分析等 | 🔄 预留 |
| 3006 | 数据库服务 | `database-service.js` | 数据库连接池管理 | 🔄 预留 |
| 3007 | 文件服务 | `file-service.js` | 文件上传下载 | 🔄 预留 |
| 3008 | 通知服务 | `notification-service.js` | 消息推送 | 🔄 预留 |
| 3009 | API网关 | `api-gateway.js` | 统一API入口 | 🔄 预留 |

---

## 🌐 前端和认证端口 (8080-8099)

| 端口 | 服务名称 | 文件名 | 功能描述 | 状态 |
|------|----------|--------|----------|------|
| **8081** | 应用端前端 | Vue 3 | 主要业务操作界面 | ✅ 运行中 |
| **8082** | 配置中心后端 | `lightweight-config-service.js` | 轻量级配置管理服务 | ✅ 运行中 |
| 8083 | 配置端前端 | Vue 2 | 系统配置管理界面 | 🔄 预留 |
| **8084** | 认证服务 | `auth-service.js` | 用户认证和权限管理 | ✅ 运行中 |
| 8085 | API网关 | `api-gateway.js` | 统一API入口 | 🔄 预留 |
| 8086 | 负载均衡器 | `load-balancer.js` | 请求分发 | 🔄 预留 |
| 8087 | 服务发现 | `service-discovery.js` | 服务注册与发现 | 🔄 预留 |
| 8088 | 监控服务 | `monitoring-service.js` | 系统监控 | 🔄 预留 |
| 8089 | 日志服务 | `logging-service.js` | 日志收集 | 🔄 预留 |

---

## 🗄️ 基础设施端口 (6000-6999)

| 端口 | 服务名称 | 功能描述 | 状态 |
|------|----------|----------|------|
| **6380** | Redis缓存 | 数据缓存和会话存储 | ✅ 运行中 |
| 6379 | Redis默认 | 系统默认Redis端口 | 🔄 预留 |
| 6432 | PostgreSQL | 关系型数据库 | 🔄 预留 |
| 6433 | MongoDB | 文档数据库 | 🔄 预留 |

---

## 🗄️ 数据库端口 (5000-5999)

| 端口 | 服务名称 | 类型 | 功能描述 | 状态 |
|------|----------|------|----------|------|
| 5432 | PostgreSQL | 关系数据库 | 主数据存储 | 🔄 可选 |
| 6379 | Redis | 缓存数据库 | 缓存和会话存储 | 🔄 可选 |
| 3306 | MySQL | 关系数据库 | 备用数据存储 | 🔄 可选 |

---

## 🔍 端口冲突检测和解决

### 🛠️ 检测命令
```bash
# 检查所有QMS端口
netstat -ano | findstr ":3004 :3005 :3009 :8080 :8082 :8073 :8084"

# 检查特定端口
netstat -ano | findstr ":8073"

# 查看进程详情
tasklist | findstr "node.exe"
```

### 🚨 冲突解决步骤
1. **识别冲突进程**
   ```bash
   netstat -ano | findstr ":端口号"
   ```

2. **停止冲突进程**
   ```bash
   taskkill /f /pid 进程ID
   ```

3. **验证端口释放**
   ```bash
   netstat -ano | findstr ":端口号"
   ```

---

## 🔄 端口变更历史

### v3.0 (当前版本 - 2025-08-06)
- **Redis**: 6379 → 6380 (避免与系统Redis冲突)
- **应用端前端**: 8080 → 8081 (避免端口冲突)
- **配置中心**: 3003 → 8082 (统一为轻量级配置服务)
- **配置端前端**: 8072 → 8083 (预留，当前未启动)

### v2.0 (历史版本)
- **配置端**: 8072 → 8073 (避免与其他服务冲突)
- **应用端**: 8080 → 8082 (让出8080给API网关)
- **配置中心**: 3003 → 3005 (统一后端端口范围)

### v1.0 (历史版本)
- 配置端: 8072
- 应用端: 8080
- 配置中心: 3003
- AI聊天: 3004

---

## 🚀 服务启动顺序 (当前实际)

### 📋 实际启动顺序
1. **Redis缓存服务** (6380) - 基础设施
2. **配置中心服务** (8082) - 配置管理
3. **认证服务** (8084) - 用户认证
4. **AI聊天服务** (3004) - 核心业务
5. **应用端前端** (8081) - 用户界面

### ⏱️ 启动间隔
- Redis启动等待: 3秒
- 后端服务间隔: 5秒
- 前端服务启动: 10秒
- 健康检查等待: 15秒

---

## 🔧 配置文件位置

### 后端服务配置 (当前运行)
```
backend/nodejs/
├── chat-service.js                    # 端口3004 ✅
├── lightweight-config-service.js      # 端口8082 ✅
├── auth-service.js                    # 端口8084 ✅
├── api-gateway.js                     # 端口8085 (预留)
└── advanced-features-service.js       # 端口3005 (预留)
```

### 前端服务配置
```
frontend/
├── 应用端/                           # 端口8081 ✅
│   ├── vite.config.js               # Vite配置
│   └── package.json                 # 依赖管理
├── 配置端/                           # 端口8083 (预留)
│   ├── vue.config.js                # Vue CLI配置
│   └── package.json                 # 依赖管理
└── 配置驱动端/                       # 端口8090 (预留)
```

### 基础设施配置
```
config/
├── redis/
│   └── redis-persistent.conf        # Redis配置 (端口6380)
└── data/
    ├── ai_models.json               # AI模型配置
    ├── services.json                # 服务配置
    └── system.json                  # 系统配置
```

---

## 🏥 健康检查端点

| 服务 | 健康检查URL | 预期响应 | 状态 |
|------|-------------|----------|------|
| AI聊天服务 | `http://localhost:3004/health` | `{"status":"ok","service":"chat"}` | ✅ |
| 配置中心 | `http://localhost:8082/health` | `{"status":"ok","service":"config"}` | ✅ |
| 认证服务 | `http://localhost:8084/health` | `{"status":"ok","service":"auth"}` | ✅ |
| 应用端前端 | `http://localhost:8081/` | 页面正常加载 | ✅ |
| Redis缓存 | 端口6380连接测试 | 连接成功 | ✅ |

---

## 🛡️ 安全考虑

### 🔒 端口安全策略
- **内部端口**: 3000-3999 (仅内网访问)
- **公开端口**: 8070-8099 (可外网访问)
- **管理端口**: 8080-8089 (需要认证)

### 🚫 防火墙规则
```bash
# 允许前端端口
ufw allow 8073
ufw allow 8082

# 允许API网关
ufw allow 8080

# 限制后端端口仅内网访问
ufw allow from 192.168.0.0/16 to any port 3004
ufw allow from 192.168.0.0/16 to any port 3005
ufw allow from 192.168.0.0/16 to any port 3009
```

---

## 📊 性能监控

### 📈 监控指标
- **端口连接数**: 每个端口的活跃连接
- **响应时间**: 健康检查响应时间
- **错误率**: 服务错误响应比例
- **资源使用**: CPU和内存使用情况

### 🔔 告警阈值
- 响应时间 > 5秒
- 错误率 > 5%
- 连接数 > 1000
- CPU使用率 > 80%

---

## 🔄 扩展规划

### 📅 未来端口分配
- **微服务扩展**: 3010-3020
- **前端模块**: 8090-8099
- **第三方集成**: 9000-9099
- **测试环境**: 7000-7999

### 🎯 容器化端口映射
```yaml
services:
  qms-chat:
    ports: ["3004:3004"]
  qms-config:
    ports: ["3005:3005"]
  qms-frontend-config:
    ports: ["8073:80"]
  qms-frontend-app:
    ports: ["8082:80"]
```
