name: ğŸ”’ å®‰å…¨æ‰«æ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 2'  # æ¯å‘¨äºŒå‡Œæ™¨3ç‚¹è¿è¡Œ

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ğŸ” CodeQL åˆ†æ
  codeql:
    name: ğŸ” CodeQL åˆ†æ
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
        
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” åˆå§‹åŒ– CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality
        
    - name: ğŸ—ï¸ è‡ªåŠ¨æ„å»º
      uses: github/codeql-action/autobuild@v2
      
    - name: ğŸ” æ‰§è¡Œ CodeQL åˆ†æ
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

  # ğŸ”’ ä¾èµ–æ¼æ´æ‰«æ
  dependency-scan:
    name: ğŸ”’ ä¾èµ–æ¼æ´æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ”’ npm audit
      run: |
        npm audit --audit-level=moderate --json > npm-audit-report.json || true
        
    - name: ğŸ”’ Snyk å®‰å…¨æ‰«æ
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --json > snyk-report.json
      continue-on-error: true
      
    - name: ğŸ“Š ä¸Šä¼  Snyk ç»“æœåˆ° GitHub
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: snyk.sarif
        
    - name: ğŸ“ˆ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          npm-audit-report.json
          snyk-report.json

  # ğŸ” å¯†é’¥æ‰«æ
  secret-scan:
    name: ğŸ” å¯†é’¥æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ” TruffleHog å¯†é’¥æ‰«æ
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # ğŸ›¡ï¸ å®¹å™¨å®‰å…¨æ‰«æ
  container-scan:
    name: ğŸ›¡ï¸ å®¹å™¨å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ³ æ„å»º Docker é•œåƒ
      run: |
        docker build -t qms-ai:latest -f config/Dockerfile .
        
    - name: ğŸ›¡ï¸ Trivy å®¹å™¨æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'qms-ai:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š ä¸Šä¼  Trivy ç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # ğŸ” SAST é™æ€åˆ†æ
  sast-scan:
    name: ğŸ” SAST é™æ€åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” Semgrep æ‰«æ
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/javascript
        generateSarif: "1"
        
    - name: ğŸ“Š ä¸Šä¼  Semgrep ç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: semgrep.sarif

  # ğŸ“Š å®‰å…¨æŠ¥å‘Šæ±‡æ€»
  security-summary:
    name: ğŸ“Š å®‰å…¨æŠ¥å‘Šæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [codeql, dependency-scan, secret-scan, container-scan, sast-scan]
    if: always()
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ ä¸‹è½½å®‰å…¨æŠ¥å‘Š
      uses: actions/download-artifact@v3
      with:
        name: security-reports
        path: ./security-reports/
        
    - name: ğŸ“Š ç”Ÿæˆå®‰å…¨æ‘˜è¦
      run: |
        echo "# ğŸ”’ QMS-AI å®‰å…¨æ‰«ææŠ¥å‘Š" > security-summary.md
        echo "" >> security-summary.md
        echo "**æ‰«ææ—¶é—´**: $(date)" >> security-summary.md
        echo "**æäº¤**: ${{ github.sha }}" >> security-summary.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> security-summary.md
        echo "" >> security-summary.md
        
        echo "## ğŸ›¡ï¸ æ‰«æç»“æœ" >> security-summary.md
        echo "" >> security-summary.md
        
        # æ£€æŸ¥å„ä¸ªæ‰«æçš„çŠ¶æ€
        if [ "${{ needs.codeql.result }}" == "success" ]; then
          echo "- âœ… CodeQL åˆ†æ: é€šè¿‡" >> security-summary.md
        else
          echo "- âŒ CodeQL åˆ†æ: å‘ç°é—®é¢˜" >> security-summary.md
        fi
        
        if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
          echo "- âœ… ä¾èµ–æ¼æ´æ‰«æ: é€šè¿‡" >> security-summary.md
        else
          echo "- âŒ ä¾èµ–æ¼æ´æ‰«æ: å‘ç°æ¼æ´" >> security-summary.md
        fi
        
        if [ "${{ needs.secret-scan.result }}" == "success" ]; then
          echo "- âœ… å¯†é’¥æ‰«æ: é€šè¿‡" >> security-summary.md
        else
          echo "- âŒ å¯†é’¥æ‰«æ: å‘ç°æ•æ„Ÿä¿¡æ¯" >> security-summary.md
        fi
        
        if [ "${{ needs.container-scan.result }}" == "success" ]; then
          echo "- âœ… å®¹å™¨å®‰å…¨æ‰«æ: é€šè¿‡" >> security-summary.md
        else
          echo "- âŒ å®¹å™¨å®‰å…¨æ‰«æ: å‘ç°æ¼æ´" >> security-summary.md
        fi
        
        if [ "${{ needs.sast-scan.result }}" == "success" ]; then
          echo "- âœ… SAST é™æ€åˆ†æ: é€šè¿‡" >> security-summary.md
        else
          echo "- âŒ SAST é™æ€åˆ†æ: å‘ç°é—®é¢˜" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "## ğŸ“‹ å»ºè®®" >> security-summary.md
        echo "" >> security-summary.md
        echo "1. å®šæœŸæ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬" >> security-summary.md
        echo "2. åŠæ—¶ä¿®å¤å‘ç°çš„å®‰å…¨æ¼æ´" >> security-summary.md
        echo "3. éµå¾ªå®‰å…¨ç¼–ç æœ€ä½³å®è·µ" >> security-summary.md
        echo "4. å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡" >> security-summary.md
        
    - name: ğŸ“ˆ ä¸Šä¼ å®‰å…¨æ‘˜è¦
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security-summary.md
