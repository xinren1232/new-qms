name: ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ

jobs:
  # ğŸ” ä»£ç è´¨é‡åˆ†æ
  code-quality:
    name: ğŸ” ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # SonarCloud éœ€è¦å®Œæ•´å†å²
        
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ è®¾ç½® pnpm
      uses: pnpm/action-setup@v2
      with:
        version: '8'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ” ESLint æ£€æŸ¥
      run: pnpm run lint --format=json --output-file=eslint-report.json
      continue-on-error: true
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
      run: pnpm run test:coverage
      
    - name: ğŸ“Š SonarCloud æ‰«æ
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        
    - name: ğŸ“ˆ ä¸Šä¼  ESLint æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: eslint-report
        path: eslint-report.json
        
    - name: ğŸ“ˆ ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        fail_ci_if_error: false

  # ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥
  dependency-check:
    name: ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ”’ npm audit
      run: npm audit --audit-level=moderate --json > npm-audit.json
      continue-on-error: true
      
    - name: ğŸ”’ Snyk å®‰å…¨æ‰«æ
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --json > snyk-report.json
      continue-on-error: true
      
    - name: ğŸ“ˆ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          npm-audit.json
          snyk-report.json

  # ğŸ“ ä»£ç å¤æ‚åº¦åˆ†æ
  complexity-analysis:
    name: ğŸ“ ä»£ç å¤æ‚åº¦åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ å®‰è£…åˆ†æå·¥å…·
      run: |
        npm install -g complexity-report
        npm install -g jscpd
        
    - name: ğŸ“ å¤æ‚åº¦åˆ†æ
      run: |
        find . -name "*.js" -not -path "./node_modules/*" | xargs cr --format json > complexity-report.json
        
    - name: ğŸ” é‡å¤ä»£ç æ£€æµ‹
      run: |
        jscpd --format json --output ./jscpd-report.json ./backend ./frontend
        
    - name: ğŸ“ˆ ä¸Šä¼ åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: complexity-reports
        path: |
          complexity-report.json
          jscpd-report.json

  # ğŸ“ æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    name: ğŸ“ æ–‡æ¡£æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“ æ£€æŸ¥ README é“¾æ¥
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'
        
    - name: ğŸ“ æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡æ¡£æ˜¯å¦å­˜åœ¨..."
        required_docs=("README.md" "QUICK-START-GUIDE.md" "docs/deployment.md")
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "âŒ ç¼ºå°‘æ–‡æ¡£: $doc"
            exit 1
          else
            echo "âœ… æ–‡æ¡£å­˜åœ¨: $doc"
          fi
        done

  # ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š
  quality-report:
    name: ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-check, complexity-analysis, documentation-check]
    if: always()
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
      uses: actions/download-artifact@v3
      
    - name: ğŸ“Š ç”Ÿæˆç»¼åˆè´¨é‡æŠ¥å‘Š
      run: |
        echo "# ğŸ† QMS-AI ä»£ç è´¨é‡æŠ¥å‘Š" > quality-report.md
        echo "" >> quality-report.md
        echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> quality-report.md
        echo "**æäº¤**: ${{ github.sha }}" >> quality-report.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> quality-report.md
        echo "" >> quality-report.md
        
        echo "## ğŸ“Š è´¨é‡æŒ‡æ ‡" >> quality-report.md
        echo "" >> quality-report.md
        
        # æ£€æŸ¥å„ä¸ªæ£€æŸ¥çš„çŠ¶æ€
        if [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "- âœ… ä»£ç è´¨é‡æ£€æŸ¥: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ ä»£ç è´¨é‡æ£€æŸ¥: å¤±è´¥" >> quality-report.md
        fi
        
        if [ "${{ needs.dependency-check.result }}" == "success" ]; then
          echo "- âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ ä¾èµ–å®‰å…¨æ£€æŸ¥: å¤±è´¥" >> quality-report.md
        fi
        
        if [ "${{ needs.complexity-analysis.result }}" == "success" ]; then
          echo "- âœ… å¤æ‚åº¦åˆ†æ: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ å¤æ‚åº¦åˆ†æ: å¤±è´¥" >> quality-report.md
        fi
        
        if [ "${{ needs.documentation-check.result }}" == "success" ]; then
          echo "- âœ… æ–‡æ¡£æ£€æŸ¥: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ æ–‡æ¡£æ£€æŸ¥: å¤±è´¥" >> quality-report.md
        fi
        
        echo "" >> quality-report.md
        echo "## ğŸ“ˆ è¯¦ç»†æŠ¥å‘Š" >> quality-report.md
        echo "" >> quality-report.md
        echo "è¯¦ç»†çš„åˆ†ææŠ¥å‘Šè¯·æŸ¥çœ‹ GitHub Actions çš„ Artifactsã€‚" >> quality-report.md
        
    - name: ğŸ“ˆ ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.md
        
    - name: ğŸ’¬ è¯„è®º PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('quality-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
