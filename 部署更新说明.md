# QMS-AI 完整部署更新说明 (软件小白专用)

## 🎯 这个脚本能为你做什么？

这个一键部署脚本会自动完成以下所有工作：

1. **🛡️ 安全备份** - 备份你当前的所有文件，确保安全
2. **🔄 代码更新** - 更新所有最新的功能和修复
3. **🔌 WebSocket修复** - 解决前端连接问题
4. **🚀 服务重启** - 重新构建和启动所有服务
5. **✅ 状态验证** - 检查所有服务是否正常运行

## 📋 使用方法

### 方法1: 在你的阿里云服务器上使用 (推荐)

1. **上传脚本到服务器**
   - 将 `QMS-AI-Complete-Deploy.sh` 上传到你的QMS项目根目录
   - 或者直接在服务器上创建这个文件

2. **给脚本执行权限**
   ```bash
   chmod +x QMS-AI-Complete-Deploy.sh
   ```

3. **运行脚本**
   ```bash
   sudo bash QMS-AI-Complete-Deploy.sh
   ```

4. **等待完成**
   - 脚本会自动完成所有步骤
   - 大约需要5-10分钟
   - 看到"🎉 部署更新完成！"就表示成功了

### 方法2: 在Windows本地使用

1. **双击运行**
   - 直接双击 `QMS-AI-Complete-Deploy.bat`
   - 或者在命令行中运行

2. **等待完成**
   - 脚本会自动完成所有步骤
   - 看到"🎉 部署更新完成！"就表示成功了

## 🔍 脚本执行过程

你会看到以下9个步骤：

```
[1/9] 检查系统环境...        ✅ 确保Docker正常运行
[2/9] 备份当前系统...        ✅ 创建安全备份
[3/9] 停止当前服务...        ✅ 优雅停止所有服务
[4/9] 更新代码文件...        ✅ 安装WebSocket依赖
[5/9] 更新Nginx配置...       ✅ 修复代理配置
[6/9] 重新构建和启动服务...   ✅ 重新部署所有服务
[7/9] 等待服务启动...        ✅ 等待服务完全启动
[8/9] 验证系统状态...        ✅ 检查所有服务健康状态
[9/9] 显示访问信息...        ✅ 显示访问地址和状态
```

## 📊 成功标志

脚本执行成功后，你会看到：

```
🎉 QMS-AI系统部署更新完成！

📋 访问地址:
  🏠 主应用: http://your-server-ip/
  ⚙️ 配置端: http://your-server-ip/config/
  🔧 API网关: http://your-server-ip:8085/
  🔌 WebSocket: ws://your-server-ip:8085/config-sync

📊 服务状态:
  ✅ 配置中心 (3003): 健康
  ✅ 聊天服务 (3004): 健康
  ✅ 应用端 (8081): 健康
  ✅ 配置端 (8072): 健康
  ✅ API网关 (8085): 健康
```

## 🔧 如果遇到问题

### 问题1: Docker未启动
**错误信息**: "Docker未安装或未启动"
**解决方法**: 
- 启动Docker Desktop (Windows)
- 或运行: `sudo systemctl start docker` (Linux)

### 问题2: 权限不足
**错误信息**: "需要root权限或sudo权限"
**解决方法**: 
- 使用 `sudo bash QMS-AI-Complete-Deploy.sh`

### 问题3: 端口被占用
**错误信息**: 端口显示"未监听"
**解决方法**: 
- 等待几分钟让服务完全启动
- 重新运行脚本

### 问题4: 服务显示"异常"
**错误信息**: 某个服务健康检查失败
**解决方法**: 
- 等待几分钟
- 查看容器日志: `docker logs container-name`
- 重新运行脚本

### 问题5: 无法访问网页
**可能原因**: 
- 阿里云安全组未开放端口
- 防火墙阻止访问

**解决方法**: 
1. **阿里云安全组配置**:
   - 登录阿里云控制台
   - 进入ECS实例管理
   - 点击"安全组" → "配置规则"
   - 添加入方向规则：
     - 端口范围：80/80，协议：TCP，授权对象：0.0.0.0/0
     - 端口范围：443/443，协议：TCP，授权对象：0.0.0.0/0
     - 端口范围：8085/8085，协议：TCP，授权对象：0.0.0.0/0

2. **防火墙配置**:
   ```bash
   # Ubuntu/Debian
   sudo ufw allow 80
   sudo ufw allow 443
   sudo ufw allow 8085
   
   # CentOS/RHEL
   sudo firewall-cmd --permanent --add-port=80/tcp
   sudo firewall-cmd --permanent --add-port=443/tcp
   sudo firewall-cmd --permanent --add-port=8085/tcp
   sudo firewall-cmd --reload
   ```

## 📁 备份和恢复

### 备份位置
脚本会自动创建备份，格式如下：
- `qms-backup-20241214_143022/` (日期时间格式)

### 如何恢复
如果需要恢复到更新前的状态：
```bash
# 停止当前服务
docker-compose down

# 恢复备份文件
cp -r qms-backup-20241214_143022/* ./

# 重新启动服务
docker-compose up -d
```

## 🆘 获取帮助

如果脚本执行失败或有其他问题：

1. **查看详细日志**:
   ```bash
   docker logs qms-api-gateway
   docker logs qms-nginx
   docker logs qms-frontend-app
   ```

2. **检查容器状态**:
   ```bash
   docker ps -a
   ```

3. **重新运行脚本**:
   ```bash
   sudo bash QMS-AI-Complete-Deploy.sh
   ```

4. **联系技术支持**:
   - 提供脚本执行的完整输出
   - 提供容器日志信息
   - 说明具体的错误现象

## 🎉 更新内容

这次更新包含：

1. **WebSocket支持** - 修复前端连接问题
2. **Nginx优化** - 改善代理配置和超时设置
3. **错误重试** - 增加服务容错能力
4. **健康检查** - 完善服务监控
5. **性能优化** - 提升系统响应速度

## 📝 注意事项

1. **执行时间**: 脚本需要5-10分钟完成
2. **网络要求**: 需要稳定的网络连接下载依赖
3. **磁盘空间**: 确保有足够的磁盘空间
4. **服务中断**: 更新期间服务会短暂中断
5. **备份重要**: 脚本会自动备份，但建议额外备份重要数据

---

**🎯 一句话总结**: 运行脚本，等待完成，享受更新后的QMS-AI系统！
