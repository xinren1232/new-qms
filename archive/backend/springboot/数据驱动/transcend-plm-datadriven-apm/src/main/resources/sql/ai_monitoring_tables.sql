-- AI问答监控系统数据库表结构
-- 创建日期: 2025-01-31

-- 1. AI问答记录表 (扩展现有的聊天记录)
CREATE TABLE IF NOT EXISTS `ai_chat_record` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
  `bid` VARCHAR(64) NOT NULL COMMENT '业务ID',
  `conversation_id` VARCHAR(128) NOT NULL COMMENT '会话ID',
  `message_id` VARCHAR(128) NOT NULL COMMENT '消息ID',
  `user_id` VARCHAR(64) NOT NULL COMMENT '用户ID/工号',
  `user_name` VARCHAR(128) COMMENT '用户姓名',
  `user_message` TEXT NOT NULL COMMENT '用户问题',
  `ai_response` TEXT COMMENT 'AI回答',
  `model_provider` VARCHAR(64) COMMENT '模型提供商',
  `model_name` VARCHAR(128) COMMENT '模型名称',
  `model_version` VARCHAR(64) COMMENT '模型版本',
  `response_time` INT COMMENT '响应时间(毫秒)',
  `token_usage` JSON COMMENT 'Token使用情况',
  `temperature` DECIMAL(3,2) COMMENT '温度参数',
  `max_tokens` INT COMMENT '最大Token数',
  `chat_status` VARCHAR(32) DEFAULT 'SUCCESS' COMMENT '对话状态: SUCCESS, FAILED, TIMEOUT',
  `error_message` TEXT COMMENT '错误信息',
  `session_id` VARCHAR(128) COMMENT '会话标识',
  `ip_address` VARCHAR(64) COMMENT '用户IP地址',
  `user_agent` VARCHAR(512) COMMENT '用户代理',
  `created_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` VARCHAR(64) COMMENT '创建人',
  `updated_by` VARCHAR(64) COMMENT '更新人',
  `delete_flag` TINYINT DEFAULT 0 COMMENT '删除标志(0-未删除；1-已删除)',
  `tenant_id` BIGINT DEFAULT 100 COMMENT '租户ID',
  INDEX `idx_conversation_id` (`conversation_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_created_time` (`created_time`),
  INDEX `idx_model_provider` (`model_provider`),
  INDEX `idx_chat_status` (`chat_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI问答记录表';

-- 2. 问答质量评价表
CREATE TABLE IF NOT EXISTS `ai_chat_feedback` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
  `bid` VARCHAR(64) NOT NULL COMMENT '业务ID',
  `chat_record_id` BIGINT NOT NULL COMMENT '问答记录ID',
  `message_id` VARCHAR(128) NOT NULL COMMENT '消息ID',
  `user_id` VARCHAR(64) NOT NULL COMMENT '评价用户ID',
  `feedback_type` VARCHAR(32) NOT NULL COMMENT '反馈类型: LIKE, DISLIKE',
  `feedback_score` TINYINT COMMENT '评分(1-5分)',
  `feedback_reason` VARCHAR(128) COMMENT '反馈原因',
  `feedback_comment` TEXT COMMENT '详细评价内容',
  `feedback_tags` JSON COMMENT '反馈标签',
  `is_helpful` TINYINT COMMENT '是否有帮助(0-否；1-是)',
  `improvement_suggestion` TEXT COMMENT '改进建议',
  `created_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` VARCHAR(64) COMMENT '创建人',
  `updated_by` VARCHAR(64) COMMENT '更新人',
  `delete_flag` TINYINT DEFAULT 0 COMMENT '删除标志(0-未删除；1-已删除)',
  `tenant_id` BIGINT DEFAULT 100 COMMENT '租户ID',
  UNIQUE KEY `uk_chat_user_feedback` (`chat_record_id`, `user_id`),
  INDEX `idx_message_id` (`message_id`),
  INDEX `idx_feedback_type` (`feedback_type`),
  INDEX `idx_created_time` (`created_time`),
  FOREIGN KEY (`chat_record_id`) REFERENCES `ai_chat_record`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI问答质量评价表';

-- 3. 用户问答统计表
CREATE TABLE IF NOT EXISTS `ai_user_statistics` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
  `bid` VARCHAR(64) NOT NULL COMMENT '业务ID',
  `user_id` VARCHAR(64) NOT NULL COMMENT '用户ID',
  `user_name` VARCHAR(128) COMMENT '用户姓名',
  `department` VARCHAR(128) COMMENT '部门',
  `statistic_date` DATE NOT NULL COMMENT '统计日期',
  `total_questions` INT DEFAULT 0 COMMENT '总提问数',
  `total_conversations` INT DEFAULT 0 COMMENT '总会话数',
  `avg_response_time` DECIMAL(10,2) COMMENT '平均响应时间(毫秒)',
  `total_tokens_used` BIGINT DEFAULT 0 COMMENT '总Token使用量',
  `successful_chats` INT DEFAULT 0 COMMENT '成功对话数',
  `failed_chats` INT DEFAULT 0 COMMENT '失败对话数',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `dislike_count` INT DEFAULT 0 COMMENT '点踩数',
  `avg_satisfaction_score` DECIMAL(3,2) COMMENT '平均满意度评分',
  `most_used_model` VARCHAR(128) COMMENT '最常用模型',
  `peak_usage_hour` TINYINT COMMENT '使用高峰时段(0-23)',
  `created_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` VARCHAR(64) COMMENT '创建人',
  `updated_by` VARCHAR(64) COMMENT '更新人',
  `delete_flag` TINYINT DEFAULT 0 COMMENT '删除标志(0-未删除；1-已删除)',
  `tenant_id` BIGINT DEFAULT 100 COMMENT '租户ID',
  UNIQUE KEY `uk_user_date` (`user_id`, `statistic_date`),
  INDEX `idx_statistic_date` (`statistic_date`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_department` (`department`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户问答统计表';

-- 4. 模型使用统计表
CREATE TABLE IF NOT EXISTS `ai_model_statistics` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
  `bid` VARCHAR(64) NOT NULL COMMENT '业务ID',
  `model_provider` VARCHAR(64) NOT NULL COMMENT '模型提供商',
  `model_name` VARCHAR(128) NOT NULL COMMENT '模型名称',
  `model_version` VARCHAR(64) COMMENT '模型版本',
  `statistic_date` DATE NOT NULL COMMENT '统计日期',
  `total_requests` INT DEFAULT 0 COMMENT '总请求数',
  `successful_requests` INT DEFAULT 0 COMMENT '成功请求数',
  `failed_requests` INT DEFAULT 0 COMMENT '失败请求数',
  `avg_response_time` DECIMAL(10,2) COMMENT '平均响应时间(毫秒)',
  `total_tokens_used` BIGINT DEFAULT 0 COMMENT '总Token使用量',
  `total_input_tokens` BIGINT DEFAULT 0 COMMENT '输入Token总数',
  `total_output_tokens` BIGINT DEFAULT 0 COMMENT '输出Token总数',
  `total_cost` DECIMAL(10,4) COMMENT '总成本',
  `unique_users` INT DEFAULT 0 COMMENT '独立用户数',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `dislike_count` INT DEFAULT 0 COMMENT '点踩数',
  `avg_satisfaction_score` DECIMAL(3,2) COMMENT '平均满意度评分',
  `peak_usage_hour` TINYINT COMMENT '使用高峰时段(0-23)',
  `error_rate` DECIMAL(5,4) COMMENT '错误率',
  `created_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` VARCHAR(64) COMMENT '创建人',
  `updated_by` VARCHAR(64) COMMENT '更新人',
  `delete_flag` TINYINT DEFAULT 0 COMMENT '删除标志(0-未删除；1-已删除)',
  `tenant_id` BIGINT DEFAULT 100 COMMENT '租户ID',
  UNIQUE KEY `uk_model_date` (`model_provider`, `model_name`, `statistic_date`),
  INDEX `idx_statistic_date` (`statistic_date`),
  INDEX `idx_model_provider` (`model_provider`),
  INDEX `idx_model_name` (`model_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='模型使用统计表';

-- 5. 系统监控指标表
CREATE TABLE IF NOT EXISTS `ai_system_metrics` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
  `bid` VARCHAR(64) NOT NULL COMMENT '业务ID',
  `metric_name` VARCHAR(128) NOT NULL COMMENT '指标名称',
  `metric_type` VARCHAR(64) NOT NULL COMMENT '指标类型: COUNTER, GAUGE, HISTOGRAM',
  `metric_value` DECIMAL(20,6) NOT NULL COMMENT '指标值',
  `metric_unit` VARCHAR(32) COMMENT '指标单位',
  `metric_tags` JSON COMMENT '指标标签',
  `statistic_time` DATETIME NOT NULL COMMENT '统计时间',
  `statistic_period` VARCHAR(32) COMMENT '统计周期: MINUTE, HOUR, DAY, WEEK, MONTH',
  `description` TEXT COMMENT '指标描述',
  `created_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` VARCHAR(64) COMMENT '创建人',
  `updated_by` VARCHAR(64) COMMENT '更新人',
  `delete_flag` TINYINT DEFAULT 0 COMMENT '删除标志(0-未删除；1-已删除)',
  `tenant_id` BIGINT DEFAULT 100 COMMENT '租户ID',
  INDEX `idx_metric_name` (`metric_name`),
  INDEX `idx_metric_type` (`metric_type`),
  INDEX `idx_statistic_time` (`statistic_time`),
  INDEX `idx_statistic_period` (`statistic_period`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统监控指标表';
