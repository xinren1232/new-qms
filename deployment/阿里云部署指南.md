# QMS-AI阿里云部署指南 - 内存优化版

## 🎯 部署目标

解决本地内存使用率过高问题（86%+），将QMS-AI系统部署到阿里云，实现：
- 内存使用优化：从1.5GB降至1GB以下
- 云端高可用部署
- 生产级监控和日志
- 自动化运维管理

## 📋 阿里云资源配置建议

### 🏗️ 基础版配置（推荐）
```yaml
ECS实例:
  规格: ecs.c6.large (2核4GB)
  数量: 1台
  操作系统: Ubuntu 20.04 LTS
  存储: 40GB SSD云盘
  带宽: 5Mbps

RDS数据库:
  规格: rds.mysql.s2.large (2核4GB)
  存储: 20GB SSD
  版本: MySQL 8.0

Redis缓存:
  规格: redis.master.small.default (1GB)
  版本: Redis 6.0

预估费用: 约400-600元/月
```

### 🚀 生产版配置（高性能）
```yaml
ECS实例:
  规格: ecs.c6.xlarge (4核8GB)
  数量: 2台（主备）
  操作系统: Ubuntu 20.04 LTS
  存储: 100GB SSD云盘
  带宽: 10Mbps

RDS数据库:
  规格: rds.mysql.s3.large (4核8GB)
  存储: 100GB SSD
  高可用: 主备版

Redis缓存:
  规格: redis.master.mid.default (4GB)
  集群版: 3节点

负载均衡: SLB应用型
CDN: 全站加速

预估费用: 约1200-1800元/月
```

## 🚀 一键部署流程

### 步骤1: 准备阿里云环境

1. **购买ECS实例**
   ```bash
   # 登录阿里云控制台
   # 选择ECS -> 创建实例
   # 配置: Ubuntu 20.04 LTS, 2核4GB, 40GB SSD
   ```

2. **购买RDS数据库**
   ```bash
   # 选择RDS -> 创建实例
   # 配置: MySQL 8.0, 2核4GB, 20GB存储
   # 记录连接信息: 主机地址、端口、用户名、密码
   ```

3. **购买Redis缓存**
   ```bash
   # 选择Redis -> 创建实例
   # 配置: Redis 6.0, 1GB内存
   # 记录连接信息: 主机地址、端口、密码
   ```

### 步骤2: 上传代码到服务器

```bash
# 方式一: 使用Git（推荐）
ssh root@your-server-ip
cd /opt
git clone https://github.com/your-username/QMS-AI.git qms
cd qms

# 方式二: 使用SCP上传
scp -r ./QMS-AI root@your-server-ip:/opt/qms
```

### 步骤3: 配置环境变量

```bash
# 复制环境变量模板
cd /opt/qms
cp deployment/.env.aliyun .env

# 编辑配置文件
vim .env

# 必须修改的配置项:
# ALIYUN_RDS_HOST=rm-xxxxxxx.mysql.rds.aliyuncs.com
# ALIYUN_RDS_PASSWORD=your_rds_password
# ALIYUN_REDIS_HOST=r-xxxxxxx.redis.rds.aliyuncs.com
# ALIYUN_REDIS_PASSWORD=your_redis_password
# DOMAIN=your-domain.com
# JWT_SECRET=your_secure_jwt_secret
# GRAFANA_PASSWORD=your_grafana_password
```

### 步骤4: 执行一键部署

```bash
# 运行部署脚本
sudo ./deployment/aliyun-deploy.sh

# 脚本将自动完成:
# 1. 安装Docker和Docker Compose
# 2. 配置系统环境
# 3. 构建和启动所有服务
# 4. 配置Nginx反向代理
# 5. 设置监控和日志
```

### 步骤5: 配置域名和SSL

```bash
# 配置域名解析
# 在域名服务商处添加A记录: your-domain.com -> your-server-ip

# 申请SSL证书
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

## 📊 内存优化配置详解

### 🔧 容器资源限制
```yaml
# 认证服务: 128MB内存限制
qms-auth-service:
  deploy:
    resources:
      limits:
        memory: 128M
        cpus: '0.3'

# 配置中心: 128MB内存限制
qms-config-service:
  deploy:
    resources:
      limits:
        memory: 128M
        cpus: '0.3'

# 聊天服务: 256MB内存限制（主要服务）
qms-chat-service:
  deploy:
    resources:
      limits:
        memory: 256M
        cpus: '0.5'

# 前端服务: 64MB内存限制
qms-frontend:
  deploy:
    resources:
      limits:
        memory: 64M
        cpus: '0.2'
```

### 🚀 Node.js内存优化
```bash
# 在Dockerfile中设置内存限制
NODE_OPTIONS=--max-old-space-size=128  # 认证和配置服务
NODE_OPTIONS=--max-old-space-size=256  # 聊天服务
```

### 💾 Redis内存优化
```bash
# Redis配置优化
maxmemory 128mb
maxmemory-policy allkeys-lru
```

## 🧭 非容器化部署（PM2 + 网关托管静态资源）

### 后端服务守护（PM2）
```bash
# 安装 PM2
npm i -g pm2 --registry=https://registry.npmmirror.com

# 使用生态配置启动三服务
cd /opt/qms-aliyun-deploy/backend/nodejs
pm2 start ecosystem.config.js
pm2 save
pm2 startup   # 可选：设置开机自启

# 查看状态与日志
pm2 status
pm2 logs qms-gateway --lines 200
```

### 前端静态资源部署（最低成本方案）
```bash
# 步骤1：构建应用端
cd frontend/应用端
npm ci
npm run build

# 将 dist 上传至服务器
scp -r dist/* root@服务器:/opt/qms-aliyun-deploy/frontend/应用端/dist/

# 步骤2：将 Nginx 根目录指向 应用端/dist（我们已在仓库中调整）
# 文件：/opt/qms-aliyun-deploy/nginx/nginx.conf
# 关键：root /usr/share/nginx/html/应用端/dist;

# 步骤3：重载 Nginx
# 容器内：docker exec -it qms-nginx nginx -t && docker exec -it qms-nginx nginx -s reload
# 非容器：nginx -t && nginx -s reload

# 可选：访问 /status 查看原首页（系统状态页）
```

> 如需继续由“API 网关”托管静态资源，可改回原指引：将 dist 放到 /opt/qms-aliyun-deploy/frontend/应用端/dist，
> 并把根路径代理到前端容器或由网关判定。但从维护成本与稳定性看，直接让 Nginx 以 应用端/dist 作为根更简单、可预期。

### 端口与健康检查
```text
配置中心: 3003   -> http://服务器:3003/health
聊天服务: 3004   -> http://服务器:3004/health
API 网关: 8085   -> http://服务器:8085/health
```

### 常见问题
- 如 / 返回“目标服务不可用”，多为未找到应用端 dist，按上文将 dist 放到 frontend/应用端/dist 并重启网关即可
- 如 /config 404，多为未找到配置端 dist，放置到 frontend/配置端/dist 并重启网关
- 重启网关：pm2 restart qms-gateway

## 🔍 监控和运维

### 📈 系统监控
```bash
# 运行监控脚本
./deployment/monitor-system.sh

# 自动监控（每30秒刷新）
watch -n 30 ./deployment/monitor-system.sh
```

### 📝 日志管理
```bash
# 查看所有服务日志
docker-compose -f deployment/aliyun-deploy-optimized.yml logs -f

# 查看特定服务日志
docker-compose -f deployment/aliyun-deploy-optimized.yml logs -f qms-chat-service

# 清理日志
docker system prune -f
```

### 🔄 服务管理
```bash
# 重启所有服务
docker-compose -f deployment/aliyun-deploy-optimized.yml restart

# 重启特定服务
docker-compose -f deployment/aliyun-deploy-optimized.yml restart qms-chat-service

# 停止所有服务
docker-compose -f deployment/aliyun-deploy-optimized.yml down

# 启动所有服务
docker-compose -f deployment/aliyun-deploy-optimized.yml up -d
```

## 🛡️ 安全配置

### 🔒 防火墙设置
```bash
# Ubuntu防火墙配置
sudo ufw enable
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw status
```

### 🔐 密钥管理
```bash
# 生成强密钥
openssl rand -base64 32  # JWT_SECRET
openssl rand -base64 32  # ENCRYPTION_KEY
```

## 📱 访问地址

部署完成后，您可以通过以下地址访问：

- **🌐 主应用**: https://your-domain.com
- **💬 AI聊天**: https://your-domain.com/ai-management/chat
- **🤖 模型管理**: https://your-domain.com/ai-management/models
- **📊 监控面板**: https://your-domain.com/grafana/
- **🔍 健康检查**: https://your-domain.com/api/chat/health

## 🚨 故障排除

### 常见问题解决

1. **内存不足**
   ```bash
   # 检查内存使用
   free -h
   docker stats
   
   # 重启高内存使用的容器
   docker-compose restart qms-chat-service
   ```

2. **服务无法启动**
   ```bash
   # 检查日志
   docker-compose logs qms-chat-service
   
   # 检查端口占用
   netstat -tuln | grep 3004
   ```

3. **数据库连接失败**
   ```bash
   # 检查RDS白名单设置
   # 确保ECS IP已添加到RDS白名单
   
   # 测试连接
   mysql -h your-rds-host -u username -p
   ```

## 📞 技术支持

如遇到部署问题，请检查：
1. 阿里云资源配置是否正确
2. 环境变量是否完整配置
3. 网络安全组是否开放相应端口
4. 域名解析是否正确指向服务器IP

---

**🎉 部署完成后，您的QMS-AI系统将拥有：**
- ✅ 内存使用优化（<1GB）
- ✅ 高可用云端部署
- ✅ 完整监控体系
- ✅ 自动化运维管理
- ✅ 生产级安全配置
