# 🚀 QMS-AI 增量更新部署指南

## 📋 概述

本指南用于在已有QMS-AI基础框架的阿里云服务器上部署最新的功能更新，包括：

- 🛠️ 全面服务管理器
- 🤖 AI智能功能优化
- 🎨 前端界面改进
- ⚡ 系统性能优化
- 🔧 新增核心服务

## 🎯 更新内容

### ✨ 新增功能

#### 🛠️ 服务管理工具
- **QMS-Service-Manager.bat** - 全面服务管理器
- **QMS-Quick-Check-And-Start.bat** - 快速检查和启动
- **QMS-Status-Check.bat** - 状态检查工具

#### 🤖 AI智能服务
- **AutoGPT执行器** - 自动化任务执行
- **CrewAI协调器** - 多智能体协作
- **LangChain内存管理** - 对话上下文管理
- **智能模型选择器** - 动态模型切换
- **插件生态系统** - 扩展功能支持

#### 🎨 前端优化
- 智能问答界面重大优化
- 右侧执行流程看板可视化
- 拖动交互功能增强
- 模型切换功能完全可用

#### ⚙️ 系统架构
- 统一配置中心驱动
- 8个AI模型正常工作
- 动态配置更新机制
- 服务健康检查完善

## 🚀 部署方法

### 方法一：Windows自动部署（推荐）

1. **在本地Windows环境运行**：
   ```bash
   cd deployment
   incremental-update.bat
   ```

2. **脚本会自动**：
   - 检查服务器连接
   - 创建系统备份
   - 拉取最新代码
   - 更新依赖包
   - 重新构建服务
   - 验证部署结果

### 方法二：Linux服务器端部署

1. **上传脚本到服务器**：
   ```bash
   scp deployment/incremental-update.sh root@47.108.152.16:/opt/qms/
   ```

2. **登录服务器执行**：
   ```bash
   ssh root@47.108.152.16
   cd /opt/qms
   chmod +x incremental-update.sh
   ./incremental-update.sh
   ```

### 方法三：手动部署

1. **登录服务器**：
   ```bash
   ssh root@47.108.152.16
   cd /opt/qms
   ```

2. **备份现有系统**：
   ```bash
   mkdir -p /opt/qms-backup-$(date +%Y%m%d-%H%M%S)
   cp -r backend frontend deployment .env /opt/qms-backup-*/
   ```

3. **停止现有服务**：
   ```bash
   docker-compose -f deployment/aliyun-deploy-optimized.yml down
   ```

4. **拉取最新代码**：
   ```bash
   git stash
   git pull origin clean-main
   ```

5. **恢复配置并重启**：
   ```bash
   # 恢复环境变量
   cp /opt/qms-backup-*/.env ./
   
   # 更新依赖
   cd backend/nodejs && npm install --production && cd ../..
   
   # 重新构建和启动
   docker-compose -f deployment/aliyun-deploy-optimized.yml build --no-cache
   docker-compose -f deployment/aliyun-deploy-optimized.yml up -d
   ```

## 🔍 验证部署

### 检查服务状态
```bash
# 查看容器状态
docker-compose -f deployment/aliyun-deploy-optimized.yml ps

# 查看服务日志
docker-compose -f deployment/aliyun-deploy-optimized.yml logs -f
```

### 测试服务连接
```bash
# 测试各服务端点
curl http://localhost:3003/health  # 配置中心
curl http://localhost:3004/health  # 聊天服务
curl http://localhost:8084/health  # 认证服务
curl http://localhost:8085/health  # API网关
```

### 访问Web界面
- **主应用**: http://47.108.152.16:8081
- **配置管理**: http://47.108.152.16:8072
- **API网关**: http://47.108.152.16:8085

## 📊 服务架构

### 后端服务 (6个)
| 服务名称 | 端口 | 功能描述 |
|---------|------|----------|
| 配置中心服务 | 3003 | 统一配置管理 |
| 聊天服务 | 3004 | AI智能问答核心 |
| Coze Studio服务 | 3005 | AI工作流编排 |
| 高级功能服务 | 3009 | 扩展功能支持 |
| 认证服务 | 8084 | 用户认证授权 |
| API网关 | 8085 | 统一接口网关 |

### 前端服务 (2个)
| 服务名称 | 端口 | 功能描述 |
|---------|------|----------|
| 应用端 | 8081 | 主要业务界面 |
| 配置端 | 8072 | 系统配置管理 |

## 🛠️ 故障排除

### 常见问题

#### 1. 服务启动失败
```bash
# 检查端口占用
netstat -tlnp | grep :3003

# 查看详细日志
docker-compose -f deployment/aliyun-deploy-optimized.yml logs service-name
```

#### 2. 内存不足
```bash
# 检查内存使用
free -h
docker stats

# 清理无用镜像
docker system prune -f
```

#### 3. 网络连接问题
```bash
# 检查防火墙
systemctl status firewalld
firewall-cmd --list-ports

# 检查Docker网络
docker network ls
```

### 回滚操作

如果更新出现问题，可以快速回滚：

```bash
# 停止当前服务
docker-compose -f deployment/aliyun-deploy-optimized.yml down

# 恢复备份
cp -r /opt/qms-backup-*/backend ./
cp -r /opt/qms-backup-*/frontend ./
cp -r /opt/qms-backup-*/deployment ./
cp /opt/qms-backup-*/.env ./

# 重新启动
docker-compose -f deployment/aliyun-deploy-optimized.yml up -d
```

## 📈 性能监控

### 系统监控命令
```bash
# 查看系统资源
htop
df -h
free -h

# 查看Docker资源使用
docker stats

# 查看服务状态
systemctl status docker
```

### 日志监控
```bash
# 实时查看应用日志
docker-compose -f deployment/aliyun-deploy-optimized.yml logs -f

# 查看系统日志
tail -f /var/log/messages
```

## 🔧 管理命令

### 常用操作
```bash
# 重启所有服务
docker-compose -f deployment/aliyun-deploy-optimized.yml restart

# 重启单个服务
docker-compose -f deployment/aliyun-deploy-optimized.yml restart qms-chat-service

# 查看服务配置
docker-compose -f deployment/aliyun-deploy-optimized.yml config

# 更新单个服务
docker-compose -f deployment/aliyun-deploy-optimized.yml up -d --no-deps qms-chat-service
```

### 维护操作
```bash
# 清理日志
docker-compose -f deployment/aliyun-deploy-optimized.yml exec qms-nginx sh -c "echo '' > /var/log/nginx/access.log"

# 备份数据
tar -czf qms-backup-$(date +%Y%m%d).tar.gz /opt/qms/data

# 更新系统
yum update -y
```

## 📞 技术支持

如遇到问题，请：

1. **检查日志**: 查看详细的错误信息
2. **验证配置**: 确认环境变量和配置文件
3. **网络测试**: 检查端口和防火墙设置
4. **资源检查**: 确认内存和磁盘空间充足

---

**更新完成后，QMS-AI系统将具备完整的企业级功能，包括智能AI服务、现代化界面和强大的管理工具！** 🎉
