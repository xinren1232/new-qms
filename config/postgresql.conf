# PostgreSQL优化配置
# 适用于QMS-AI系统

#------------------------------------------------------------------------------
# 连接和认证设置
#------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200                    # 增加最大连接数
superuser_reserved_connections = 3

#------------------------------------------------------------------------------
# 内存设置
#------------------------------------------------------------------------------
shared_buffers = 256MB                   # 共享缓冲区，通常设为内存的25%
effective_cache_size = 1GB               # 操作系统缓存大小估计
work_mem = 4MB                          # 单个查询操作的内存
maintenance_work_mem = 64MB              # 维护操作内存
max_stack_depth = 2MB

# 临时文件设置
temp_buffers = 8MB
max_files_per_process = 1000

#------------------------------------------------------------------------------
# WAL (Write-Ahead Logging) 设置
#------------------------------------------------------------------------------
wal_level = replica                      # 支持流复制
wal_buffers = 16MB                      # WAL缓冲区
max_wal_size = 1GB                      # WAL最大大小
min_wal_size = 80MB                     # WAL最小大小
checkpoint_completion_target = 0.9       # 检查点完成目标
checkpoint_timeout = 5min               # 检查点超时

# WAL归档（如果需要）
archive_mode = off
# archive_command = 'cp %p /var/lib/postgresql/archive/%f'

#------------------------------------------------------------------------------
# 查询规划器设置
#------------------------------------------------------------------------------
random_page_cost = 1.1                  # SSD优化
effective_io_concurrency = 200          # SSD并发IO
default_statistics_target = 100         # 统计信息目标

# 成本估算
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

#------------------------------------------------------------------------------
# 错误报告和日志
#------------------------------------------------------------------------------
logging_collector = on
log_destination = 'stderr'
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 100MB

# 日志内容设置
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000       # 记录执行时间超过1秒的查询
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_statement = 'mod'                   # 记录DDL和DML语句
log_temp_files = 10MB                   # 记录大于10MB的临时文件

# 慢查询日志
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

#------------------------------------------------------------------------------
# 运行时统计
#------------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = '/var/run/postgresql/stats_temp'

#------------------------------------------------------------------------------
# 自动清理设置
#------------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = 200

#------------------------------------------------------------------------------
# 客户端连接默认设置
#------------------------------------------------------------------------------
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# 锁管理
#------------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64

#------------------------------------------------------------------------------
# 版本和平台设置
#------------------------------------------------------------------------------
dynamic_shared_memory_type = posix

#------------------------------------------------------------------------------
# 性能优化设置
#------------------------------------------------------------------------------
# 并行查询
max_parallel_workers_per_gather = 2
max_parallel_workers = 8
max_worker_processes = 8
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0

# JIT编译（PostgreSQL 11+）
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

#------------------------------------------------------------------------------
# 扩展和模块
#------------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements设置
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

#------------------------------------------------------------------------------
# 复制设置（如果需要主从复制）
#------------------------------------------------------------------------------
# 主服务器设置
# wal_level = replica
# max_wal_senders = 3
# wal_keep_segments = 32
# synchronous_standby_names = ''

# 从服务器设置
# hot_standby = on
# max_standby_archive_delay = 30s
# max_standby_streaming_delay = 30s
# wal_receiver_status_interval = 10s
# hot_standby_feedback = on

#------------------------------------------------------------------------------
# 安全设置
#------------------------------------------------------------------------------
ssl = off
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'
# ssl_ca_file = 'ca.crt'
# ssl_crl_file = 'ca.crl'

# 密码加密
password_encryption = md5

#------------------------------------------------------------------------------
# 资源使用限制
#------------------------------------------------------------------------------
max_stack_depth = 2MB
dynamic_shared_memory_type = posix

# 后台写进程
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# 检查点写进程
checkpoint_flush_after = 256kB

#------------------------------------------------------------------------------
# 开发和调试设置（生产环境建议关闭）
#------------------------------------------------------------------------------
# log_statement_stats = off
# log_parser_stats = off
# log_planner_stats = off
# log_executor_stats = off
